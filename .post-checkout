#!/usr/bin/env zsh

setopt null_glob
WORKDIR="${$(git rev-parse --show-toplevel):-$PWD}"
CRYPTDIR="..."
C="${CYPHER:-$(git config crypt.cypher)}"
P="${CRYPTPASS:-$(git config crypt.pass)}"

if test -d "${WORKDIR}/${CRYPTDIR}"; then
  FILES=(${WORKDIR}/${CRYPTDIR}/*)
  test -n "${FILES}" && for b in ${FILES}; do
    c=$(tr -- "-_" "+/" <<< "$(basename ${b})" | openssl enc -A -${C} -base64 -d -pass "pass:${P}")
    d=$(dirname "${c}")
    test -d "${d}" || mkdir -m go= -p "${d}"
    if ! git rev-parse --git-dir > /dev/null 2>&1; then openssl enc -A -${C} -base64 -d -pass "pass:${P}" -in "${b}" -out "${c}"; fi
    test ! -f "${c}" && ln "${b}" "${c}"
  done
fi
